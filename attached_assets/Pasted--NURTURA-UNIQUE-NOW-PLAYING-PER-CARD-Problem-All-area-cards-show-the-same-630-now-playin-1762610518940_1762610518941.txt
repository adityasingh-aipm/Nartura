# NURTURA UNIQUE "NOW PLAYING" PER CARD

**Problem:** All area cards show the same "630 now playing" number
**Solution:** Each card shows a DIFFERENT randomized number (100-999)

Each area gets its own unique "now playing" count that:
- Varies between 100-999
- Is different from every other card
- Changes when user revisits the page (refreshes the app)
- Creates more dynamic, authentic feel

---

## ğŸ”§ STEP 1: Update Database Schema

### Add this column to `development_areas` table:

```sql
ALTER TABLE development_areas ADD COLUMN now_playing INTEGER DEFAULT 0;
```

Or if creating fresh:

```sql
CREATE TABLE development_areas (
  id INTEGER PRIMARY KEY,
  baby_id INTEGER,
  area_name TEXT,
  development_type TEXT,
  age_range_min INTEGER,
  age_range_max INTEGER,
  icon_emoji TEXT,
  background_color TEXT,
  description TEXT,
  activity_count INTEGER,
  now_playing INTEGER DEFAULT 0,
  created_at TIMESTAMP,
  FOREIGN KEY (baby_id) REFERENCES babies(id)
);
```

---

## ğŸ”§ STEP 2: Create Helper Functions

### Add these functions to `app.py`:

```python
import random

def generate_area_now_playing_numbers(num_areas):
    """
    Generate unique random numbers for each area (100-999).
    Each number is different from others.
    Returns list of unique numbers.
    """
    # Generate unique random numbers
    unique_numbers = random.sample(range(100, 1000), min(num_areas, 900))
    return unique_numbers


def refresh_all_area_now_playing(baby_id):
    """
    Generate new 'now playing' numbers for ALL areas of a baby.
    Called on each /home visit to create freshness.
    """
    # Get all areas for this baby
    areas = db.execute(
        'SELECT id FROM development_areas WHERE baby_id = ?',
        (baby_id,)
    ).fetchall()
    
    if not areas:
        return
    
    # Generate unique random numbers for all areas
    num_areas = len(areas)
    unique_numbers = random.sample(range(100, 1000), min(num_areas, 900))
    
    # Update each area with unique number
    for area, now_playing in zip(areas, unique_numbers):
        db.execute(
            'UPDATE development_areas SET now_playing = ? WHERE id = ?',
            (now_playing, area['id'])
        )
    
    db.commit()
    print(f"âœ“ Refreshed 'now playing' for {num_areas} areas")


def get_area_now_playing(area_id):
    """
    Get the 'now playing' number for a specific area.
    """
    area = db.execute(
        'SELECT now_playing FROM development_areas WHERE id = ?',
        (area_id,)
    ).fetchone()
    
    return area['now_playing'] if area else random.randint(100, 999)
```

---

## ğŸ”§ STEP 3: Update Home Route

### Find this in `app.py`:

```python
@app.route('/home')
@login_required
def home():
```

### Replace the beginning with this version:

```python
@app.route('/home')
@login_required
def home():
    """
    Show areas screen (homepage) with development areas for the baby.
    Generate UNIQUE 'Now Playing' number for EACH area on each visit.
    """
    user_id = session['user_id']
    baby = get_baby_by_user(user_id)
    
    if not baby:
        return redirect('/onboarding')
    
    # Check if areas already generated
    existing_areas = db.execute(
        'SELECT * FROM development_areas WHERE baby_id = ? ORDER BY development_type',
        (baby.id,)
    ).fetchall()
    
    if not existing_areas:
        # First visit: Generate areas based on age + goals
        areas = generate_development_areas(baby)
        
        # Store in DB
        for area in areas:
            db.execute(
                '''INSERT INTO development_areas 
                   (baby_id, area_name, development_type, age_range_min, age_range_max, 
                    icon_emoji, background_color, description, activity_count, now_playing)
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)''',
                (baby.id, area['name'], area['type'], area['age_min'], 
                 area['age_max'], area['emoji'], area['color'], area['description'], 
                 area.get('activity_count', 3), random.randint(100, 999))
            )
        db.commit()
        existing_areas = db.execute(
            'SELECT * FROM development_areas WHERE baby_id = ? ORDER BY development_type',
            (baby.id,)
        ).fetchall()
    
    else:
        # Existing areas: Refresh 'now playing' numbers on each visit
        refresh_all_area_now_playing(baby.id)
        
        # Reload areas with new numbers
        existing_areas = db.execute(
            'SELECT * FROM development_areas WHERE baby_id = ? ORDER BY development_type',
            (baby.id,)
        ).fetchall()
    
    return render_template('areas.html', baby=baby, areas=existing_areas)
```

---

## ğŸ”§ STEP 4: Update HTML Template

### In `templates/areas.html`, find this section:

```html
<span class="now-playing">ğŸ”¥ {{ now_playing }} now playing</span>
```

### Replace with:

```html
<span class="now-playing">ğŸ”¥ {{ area.now_playing }} now playing</span>
```

---

## ğŸ”§ STEP 5: Update CSS (Optional Enhancement)

### In `templates/areas.html` `<style>`, find:

```css
.now-playing {
  background: rgba(255, 255, 255, 0.95);
  color: #FF6B35;
  padding: 6px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 700;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 4px;
  letter-spacing: 0.5px;
  animation: pulse 2s infinite;
}
```

### Keep as is (no changes needed) OR update animation to be more dynamic:

```css
.now-playing {
  background: rgba(255, 255, 255, 0.95);
  color: #FF6B35;
  padding: 6px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 700;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 4px;
  letter-spacing: 0.5px;
  animation: pulse 2s infinite;
  transition: all 300ms ease;
}

.now-playing:hover {
  transform: scale(1.05);
  background: rgba(255, 255, 255, 1);
  box-shadow: 0 2px 8px rgba(255, 107, 53, 0.2);
}
```

---

## ğŸ“± OPTIONAL: Add Debug Endpoints

### Add these to `app.py` for testing:

```python
@app.route('/debug/area-now-playing')
@login_required
def debug_area_now_playing():
    """
    Show 'now playing' numbers for all areas
    """
    user_id = session['user_id']
    baby = get_baby_by_user(user_id)
    
    if not baby:
        return jsonify({'error': 'No baby found'}), 400
    
    areas = db.execute(
        'SELECT area_name, now_playing FROM development_areas WHERE baby_id = ? ORDER BY area_name',
        (baby.id,)
    ).fetchall()
    
    result = []
    for area in areas:
        result.append({
            'area_name': area['area_name'],
            'now_playing': area['now_playing']
        })
    
    return jsonify(result)


@app.route('/debug/refresh-now-playing')
@login_required
def debug_refresh_now_playing():
    """
    Manually refresh now playing numbers (for testing)
    """
    user_id = session['user_id']
    baby = get_baby_by_user(user_id)
    
    if not baby:
        return jsonify({'error': 'No baby found'}), 400
    
    refresh_all_area_now_playing(baby.id)
    
    areas = db.execute(
        'SELECT area_name, now_playing FROM development_areas WHERE baby_id = ? ORDER BY area_name',
        (baby.id,)
    ).fetchall()
    
    result = []
    for area in areas:
        result.append({
            'area_name': area['area_name'],
            'now_playing': area['now_playing']
        })
    
    return jsonify({
        'status': 'refreshed',
        'areas': result
    })
```

---

## ğŸ§ª TESTING PROCEDURE

### Test 1: Check Initial State

Visit `/home` and look at the area cards.

**Expected:** Each card shows a DIFFERENT number:
```
"ğŸ”¥ 342 now playing"   â† Card 1
"ğŸ”¥ 789 now playing"   â† Card 2 (different!)
"ğŸ”¥ 156 now playing"   â† Card 3 (different!)
"ğŸ”¥ 623 now playing"   â† Card 4 (different!)
```

### Test 2: Debug Endpoint (Optional)

```
GET /debug/area-now-playing
```

**Response:**
```json
[
  {
    "area_name": "Problem Solving and Logical Thinking",
    "now_playing": 342
  },
  {
    "area_name": "Counting and Number Recognition",
    "now_playing": 789
  },
  {
    "area_name": "Conversation and Storytelling",
    "now_playing": 156
  }
]
```

### Test 3: Refresh Test

Refresh the page or revisit `/home`.

**Expected:** All numbers change to NEW unique values:
```
"ğŸ”¥ 512 now playing"   â† Changed!
"ğŸ”¥ 238 now playing"   â† Changed!
"ğŸ”¥ 987 now playing"   â† Changed!
```

Each number is still unique from the others.

### Test 4: App Restart

1. Visit `/home` - see numbers (e.g., 342, 789, 156)
2. Close browser/app completely
3. Reopen and visit `/home`
4. Numbers should be completely different (e.g., 512, 238, 987)

---

## âœ… IMPLEMENTATION CHECKLIST

- [ ] Add `now_playing` column to `development_areas` table
- [ ] Add `generate_area_now_playing_numbers()` function
- [ ] Add `refresh_all_area_now_playing()` function
- [ ] Add `get_area_now_playing()` function
- [ ] Update `/home` route to call `refresh_all_area_now_playing()`
- [ ] Update areas table in database:
  ```sql
  ALTER TABLE development_areas ADD COLUMN now_playing INTEGER DEFAULT 0;
  ```
- [ ] Update template: Change `{{ now_playing }}` to `{{ area.now_playing }}`
- [ ] Add debug endpoints (optional)
- [ ] Test: Visit `/home` - verify each card has different number
- [ ] Test: Refresh page - numbers should change
- [ ] Test: Close and reopen app - numbers should be different
- [ ] Deploy to Replit

---

## ğŸ¯ EXPECTED BEHAVIOR

**Current (Wrong):**
```
Card 1: ğŸ”¥ 630 now playing
Card 2: ğŸ”¥ 630 now playing  â† Same as Card 1 âœ—
Card 3: ğŸ”¥ 630 now playing  â† Same as Card 1 âœ—
Card 4: ğŸ”¥ 630 now playing  â† Same as Card 1 âœ—
```

**After Fix (Correct):**
```
Card 1: ğŸ”¥ 342 now playing  â† Unique!
Card 2: ğŸ”¥ 789 now playing  â† Unique!
Card 3: ğŸ”¥ 156 now playing  â† Unique!
Card 4: ğŸ”¥ 623 now playing  â† Unique!
```

On refresh/revisit: All numbers change to new unique values.

---

## ğŸ’¡ HOW IT WORKS

**First Visit:**
- User arrives at `/home`
- System generates unique random number for each area (100-999)
- Stores in database `now_playing` column
- Displays different number on each card

**Revisit or Refresh:**
- User comes back to `/home`
- System calls `refresh_all_area_now_playing()`
- Generates NEW unique random numbers for all areas
- Updates database
- Displays NEW different numbers on each card

**App Restart:**
- User closes app completely
- Returns later
- Same process: fresh unique numbers generated

---

## ğŸš€ READY?

Paste this entire prompt into Replit AI and it will:
1. Add database column
2. Create unique number generation functions
3. Update home route to refresh numbers
4. Update template to display per-card numbers
5. Add debug endpoints

Each area card will now show a DIFFERENT "now playing" number! ğŸ”¥